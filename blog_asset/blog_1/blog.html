<!DOCTYPE html>
<html lang="vi">
<head>
<link rel="icon" href="../../favicon.png" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Control Flow Flattening Deobfuscate</title>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
}

body{
    background:black;
    color:white;
    font-family: 'Calibri','Calibri Body',sans-serif;
    line-height:1.6;
}

/* TITLE */

.title-wrapper{
    width:100%;
    display:flex;
    justify-content:center;
    z-index:1000;
}

.title{
    font-size:42px;
    font-weight:bold;
    padding-top:50px;
    text-align:center;

    background:linear-gradient(to right,#00e1ff,#ff62d0);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
}

/* CONTENT */

main{
    max-width:900px;
    margin:auto;
    padding:110px 20px 60px;
}

h1,h2,h3{
    margin-top:40px;
    margin-bottom:10px;
}

p{
    margin-bottom:18px;
    opacity:0.9;
}

ul{
    margin-left:20px;
    margin-bottom:18px;
}

code{
    background:#111;
    padding:2px 6px;
    border-radius:4px;
    color:#00e1ff;
}

pre{
    background:#0b0b0b;
    padding:16px;
    border-radius:8px;
    overflow:auto;
    margin-bottom:24px;
}

/* IMAGE */

.hero-img{
    width:100%;
    height:400px;
    object-fit:cover;
    border-radius:12px;
    margin-bottom:40px;
}

.image-container{
    width:100%;
    margin-bottom:20px;
}

.image-container img{
    width:100%;
    height:400px;
    object-fit:cover;
    border-radius:12px;
    display:block;
}

</style>
</head>

<body>

<div class="title-wrapper">
<pre class="title" style="font-family:'Calibri','Calibri Body',sans-serif;">Nghá»‹ch ngá»£m deobfuscate CFF</pre>
</div>

<main>

<img class="hero-img" src="cff.jpg" alt="CFF banner">
<p>
    Äá»‘i vá»›i anh em Reverse thÃ¬ CFF khÃ´ng cÃ²n quÃ¡ xa láº¡ rá»“i. CFF gáº·p khÃ´ng chá»‰ trong CTF, mÃ  malware dÃ¹ng cÅ©ng ráº¥t nhiá»u.
</p>
<p>
    ÄÃ¢y lÃ  1 kiá»ƒu flow obfuscate theo mÃ¬nh Ä‘Ã¡nh giÃ¡ thÃ¬ ráº¥t khÃ³ chá»‹u, khÃ´ng nhá»¯ng khÃ³ chá»‹u khi mÃ¬nh debug mÃ  cÃ²n lÃ m khÃ³ cáº£ nhá»¯ng tool deobfuscate CFF. Nhá»¯ng hrtng, d810 deobfuscate CFF báº±ng ida  microcode cÃ³ thá»ƒ ráº¥t ok á»Ÿ nhá»¯ng máº«u obfus CFF Ä‘Æ¡n giáº£n, tuy nhiÃªn vá»›i cÃ¡c dáº¡ng CFF cÃ³ nhiá»u variant hÆ¡n thÃ¬ ráº¥t dá»… ngá»ng â€“ bá»Ÿi cÃ¡c block microcode hoáº¡t Ä‘á»™ng theo dáº¡ng double linked list:
</p>
<img class="image-container" src="1.jpg" alt="CFF1">
<p>
    Trong quÃ¡ trÃ¬nh deobfuscate CFF, cÃ¡c block nÃ y sáº½ Ä‘Æ°á»£c xá»­ lÃ½ báº±ng cÃ¡ch sá»­a cÃ¡c link vá» Ä‘Ãºng block cá»§a flow, tuy nhiÃªn cÃ³ thá»ƒ cÃ¡c tool deob khÃ´ng build Ä‘Ãºng link cho cÃ¡c block, giáº£ sá»­ nhÆ° block1 vÃ  block2 khÃ´ng double linked vá»›i nhau, khi nÃ y sáº½ dáº«n Ä‘áº¿n internal error cá»§a IDA. 
</p>
<p>
    NgoÃ i ra, chÃ­nh viá»‡c khÃ´ng hiá»ƒu Ä‘Æ°á»£c cÃ¡c pattern cá»§a cÃ¡c biáº¿n thá»ƒ, khiáº¿n cho cÃ¡c tool nÃ y khÃ´ng thá»ƒ deob chÃ­nh xÃ¡c Ä‘Æ°á»£c. Tá»« Ä‘Ã³ mÃ¬nh nghÄ© ráº±ng nÃªn tá»± custom deob láº¡i, cÅ©ng lÃ  Ä‘á»ƒ hiá»ƒu sÃ¢u hÆ¡n vá» CFF. MÃ¬nh cÅ©ng tá»«ng deob thá»­ báº±ng microcode, tuy nhiÃªn cÃ¡c block sáº½ Ä‘Æ°á»£c xá»­ lÃ½ qua nhiá»u maturity level Ä‘á»ƒ tiáº¿n gáº§n hÆ¡n vá»›i mÃ£ giáº£ mÃ  chÃºng ta tháº¥y:
</p>
<img class="image-container" src="2.jpg" alt="CFF2">
<p>
    NÃªn cÃ¡c block á»Ÿ dáº¡ng assembly ban Ä‘áº§u cÃ³ thá»ƒ khÃ´ng match vá»›i cÃ¡c block á»Ÿ cÃ¡c maturity level sau. ThÃªm ná»¯a lÃ  vÃ¬ khÃ´ng cÃ³ graph nÃªn khi gáº·p error khi double linked list sai, mÃ¬nh cÅ©ng ráº¥t khÃ³ Ä‘á»ƒ theo dÃµi. Tháº¿ nÃªn khi má»›i tiáº¿p cáº­n, mÃ¬nh khÃ¡ lÃ  máº¥t thá»i gian trong viá»‡c match block Ä‘á»ƒ cÃ³ thá»ƒ deobfuscate Ä‘Ãºng.
</p>
<p>
    1 thá»i gian sau, khi ráº£nh rang láº¡i, mÃ¬nh quay láº¡i vá»›i CFF vÃ¬ cáº£m tháº¥y trÆ°á»›c Ä‘Ã¢y deob chÆ°a Ä‘Ã¢u vÃ o Ä‘Ã¢u. VÃ  láº§n nÃ y, thay vÃ¬ microcode chá»‰ Ä‘á»ƒ xem mÃ£ giáº£ deob, sao ta khÃ´ng xiÃªn tháº³ng raw assembly luÃ´n nhá»‰, mÃ¬nh Ä‘Ã£ nghÄ© váº­y vÃ  thá»±c hiá»‡n luÃ´n :D
</p>

<h2>Sample 1 â€” PlugX Variant</h2>

<p>
    Máº«u Ä‘áº§u tiÃªn mÃ  mÃ¬nh sá»­ dá»¥ng Ä‘á»ƒ deob CFF á»Ÿ Ä‘Ã¢y lÃ  1 biáº¿n thá»ƒ PlugX.
</p>

<pre><code>libcef.dll - 1c08a922c3cc4cd2733f09785d10be98</code></pre>

<p>
    Máº«u nÃ y chá»‰ bá»‹ CFF 3 hÃ m Ä‘áº§u tiÃªn, cÅ©ng lÃ  main work cá»§a malware:
</p>
<img class="image-container" src="3.jpg" alt="CFF3">
<p>
    HÃ m export cef_api_hash vá»›i 0x10017655 thÃ¬ tÆ°Æ¡ng Ä‘á»‘i dá»… nhÃ¬n, chÃºng ta sáº½ Ä‘i vÃ o deob 2 hÃ m nÃ y trÆ°á»›c:
</p>
<img class="image-container" src="4.jpg" alt="CFF4">
<img class="image-container" src="5.jpg" alt="CFF5">
<h2>1. CFF Base</h2>
<p>
    NhÆ° ta Ä‘Ã£ biáº¿t, CFF flat flow ra thÃ nh cÃ¡c block cÃ¹ng cáº¥p. Flow CFF qua tá»«ng flattened block sáº½ Ä‘Æ°á»£c switch thÃ´ng qua 1 block gá»i lÃ  <code>Dispatcher</code>. 
    NhÃ¬n hÃ¬nh sau cÃ³ thá»ƒ tháº¥y, block Dispatcher nÃ y cÃ³ nhiá»u block trá» vá» nÃ³ nháº¥t:
</p>
<img class="image-container" src="6.jpg" alt="CFF6">
<p>
    Tá»« block Dispatcher nÃ y, ta cÃ³ thÃ´ng tin lÃ  EAX lÃ  dispatch register.
    Trong quÃ¡ trÃ¬nh quan sÃ¡t, ta cÅ©ng Ä‘á»ƒ Ã½ tháº¥y cÃ³ cÃ¡c block mov imm32 vÃ o dispatch register kiá»ƒu nhÆ° nÃ y: 
</p>
<img class="image-container" src="7.jpg" alt="CFF7">
<p>
    VÃ  cÃ¡c block compare imm32 vá»›i dispatch register:
</p>
<img class="image-container" src="8.jpg" alt="CFF8">

<p>
    ThÃ¬ Ã½ tÆ°á»Ÿng cá»§a mÃ¬nh lÃ  sáº½ ná»‘i tháº³ng block nÃ o mov eax, imm32 vá»›i cmp imm32, eax tÆ°Æ¡ng á»©ng. VÃ­ dá»¥ 2 block sau sáº½ Ä‘Æ°á»£c ná»‘i liá»n vÃ o nhau:
</p>
<img class="image-container" src="9.jpg" alt="CFF9">
<img class="image-container" src="10.jpg" alt="CFF10">

<p>
Tuy nhiÃªn váº«n chÆ°a lÃ  Ä‘á»§, bá»Ÿi cÃ¡c block cmp váº«n chia ra 2 nhÃ¡nh theo jnz vÃ  jz mÃ  Ä‘Ãºng khÃ´ng :>. NhÆ°ng thÃ´ng qua quÃ¡ trÃ¬nh debug, mÃ¬nh Ä‘á»ƒ Ã½ cÃ¡c â€œblock tháº­t sá»±â€ cá»§a luá»“ng chÆ°Æ¡ng trÃ¬nh chÃ­nh luÃ´n náº±m á»Ÿ nhÃ¡nh False cá»§a jnz vÃ  nhÃ¡nh True cá»§a jz. á» Ä‘Ã¢y mÃ¬nh sáº½ highlight lÃªn cho má»i ngÆ°á»i dá»… nhÃ¬n: 
</p>

<img class="image-container" src="11.jpg" alt="CFF11">
<img class="image-container" src="12.jpg" alt="CFF12">
<p>
    Tá»« Ä‘Ã¢y, mÃ¬nh cÃ³ 1 chain deobfuscate nhÆ° sau:
</p>
<img class="image-container" src="13.jpg" alt="CFF13">
<p>
    Trong nhiá»u máº«u CFF mÃ¬nh gáº·p, Ä‘á»u tuÃ¢n theo quy táº¯c nÃ y, Ä‘Ã¢y cÃ³ thá»ƒ coi nhÆ° trÃ¡i tim cá»§a CFF. 
</p>
<h2>2. Variant Patterns</h2>

<h3>2.1. Variant CMOVZ</h3>
<p>
    Táº¡i hÃ m 0x10017655, mÃ¬nh cÅ©ng phÃ¡t hiá»‡n Ä‘Æ°á»£c thÃªm 1 variant sá»­ dá»¥ng CMOVZ:
</p>
<img class="image-container" src="14.jpg" alt="CFF14">
<p>
    CMOVZ sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° 1 switch Ä‘á»ƒ khiáº¿n block nÃ y Ä‘i theo 2 nhÃ¡nh khÃ¡c nhau.
    Vá»›i 2 giÃ¡ trá»‹ cá»§a dispatch reg vÃ  temp reg lÃ  0xCE56232 vÃ  0x808D22D6 (táº¡m gá»i lÃ  main imm32 vÃ  sub imm32), qua viá»‡c debug báº±ng list cÃ¡c block cmp match vá»›i 2 giÃ¡ trá»‹ nÃ y, mÃ¬nh nháº­n tháº¥y:
</p>
<ul>
<li>Sub imm32 sáº½ khiáº¿n chÆ°Æ¡ng trÃ¬nh luÃ´n nháº£y vá» block match imm32 gáº§n nháº¥t.</li>
<li>Main imm32 cÅ©ng tÆ°Æ¡ng tá»±, luÃ´n khiáº¿n chÆ°Æ¡ng trÃ¬nh vá» block match imm32 cÃ³ Ä‘á»‹a chá»‰ gáº§n nháº¥t.</li>
</ul>
<p>
    Tá»« Ä‘Ã³ mÃ¬nh cÃ³ flow xá»­ lÃ½ variant nÃ y nhÆ° sau:
</p>
<img class="image-container" src="15.jpg" alt="CFF15">
<p>
    Ta cÃ³ output khÃ¡ clean, lÃ  1 hÃ m resolve API qua GetProcAddress vá»›i Module loop tá»« PEB:
</p>
<img class="image-container" src="16.jpg" alt="CFF16">
<h3>2.2. Variant CMOVB</h3>
<p>
    NhÆ° 2 hÃ m mÃ¬nh Ä‘Ã£ Ä‘á» cáº­p bÃªn trÃªn, nÃ³ khÃ¡ lÃ  dá»… theo dÃµi vÃ  graph cÅ©ng khÃ¡ nhá» Ä‘á»ƒ theo dÃµi cÅ©ng nhÆ° hiá»ƒu mÃ  deob. NhÆ°ng Ã¡c má»™ng cá»§a mÃ¬nh quay trá»Ÿ láº¡i khi tá»›i vá»›i hÃ m 0x10001040, trÆ°á»›c háº¿t lÃ  nÃ³ quÃ¡ to Ä‘á»ƒ cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c háº¿t variant â˜¹:
</p>
<img class="image-container" src="17.jpg" alt="CFF17">
<p>
    Thá»© 2 lÃ  khÃ´ng Ä‘Æ¡n thuáº§n chá»‰ sá»­ dá»¥ng 1 dispatch register ná»¯a, hÃ m nÃ y sá»­ dá»¥ng thÃªm cÃ¡c nested dispath register khÃ¡c nhÆ° ecx, edx, esi, edi:
</p>
<img class="image-container" src="18.jpg" alt="CFF18">
<p>
    Äiá»u nÃ y gÃ¢y khÃ³ cho mÃ¬nh khi tÃ¬m toÃ n bá»™ cÃ¡c dispatch reg, bá»Ÿi, cÃ¡c hÃ m Ä‘Æ¡n giáº£n chá»‰ cÃ³ 1 block lÃ  Ä‘Æ°á»£c trá» nhiá»u nháº¥t (cháº¯c cháº¯n lÃ  dispatcher). Váº­y náº¿u cÃ³ nhiá»u block cÅ©ng Ä‘Æ°á»£c trá» nhiá»u nhÆ° tháº¿ thÃ¬ pháº£i lÃ m sao?
</p>
<p>
    MÃ¬nh Ä‘i Ä‘áº¿n Ã½ tÆ°á»Ÿng loáº¡i bá» cÃ¡c block chá»‰ cÃ³ predset count lÃ  0, 1,2 (bá»Ÿi vÃ¬ cÃ¡c block nÃ y ráº¥t phá»• thÃ´ng pháº£i khÃ´ng, chÆ°Æ¡ng trÃ¬nh nÃ o cÅ©ng cÃ³). VÃ  nhá»¯ng block cÃ²n láº¡i, náº¿u predset count cá»§a nÃ³ xuáº¥t hiá»‡n quÃ¡ Ã­t so vá»›i cÃ¡c block khÃ¡c trong chÆ°Æ¡ng trÃ¬nh (cÃ¡i nÃ y khÃ¡ false positive, mÃ¬nh chÆ°a tÃ¬m ra thuáº­t toÃ¡n nÃ o há»£p lÃ½ :v), mÃ¬nh sáº½ nháº­n Ä‘á»‹nh Ä‘Ã¢y chÃ­nh lÃ  dispatcher vÃ  nested dispatcher. VÃ  tá»« Ä‘Ã³ mÃ¬nh tÃ¬m ra dispatch reg nhÆ° sau:
</p>
<img class="image-container" src="19.jpg" alt="CFF19">
<p>
    ThÃ¬ Ã½ tÆ°á»Ÿng cÅ©ng khÃ¡ lÃ  dá»… thÃ´i, nested dispatcher nghe thÃ¬ háº§m há»‘ nhÆ°ng thá»±c ra thá»±c hiá»‡n loop deob vá»›i tá»«ng dispatch khÃ¡c nhau lÃ  Ä‘Æ°á»£c mÃ  ğŸ˜Š.
</p>
<p>
    Sau khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c dispatchers vÃ  deob theo cÃ¡c bÆ°á»›c Ä‘Ã£ lÃ m vá»›i 2 hÃ m kia, mÃ¬nh nháº­n ra táº¡i Ä‘Ã¢y cÃ³ 1 variant ná»¯a lÃ  CMOVB. ÄÃ¢y lÃ  variant tá»‘n thá»i gian nháº¥t cá»§a mÃ¬nh vÃ¬ debug vÃ  Ä‘oÃ¡n pattern hoáº¡t Ä‘á»™ng tÆ°Æ¡ng Ä‘á»‘i khÃ³. á» Ä‘Ã¢y, ta theo dÃµi 1 block cá»§a variant nÃ y:
</p>
<img class="image-container" src="20.jpg" alt="CFF20">
<p>
    Giá»‘ng vá»›i CMOVZ, dá»… tháº¥y nÃ³ cÅ©ng sá»­ dá»¥ng 2 imm32 Ä‘á»ƒ switch flow. Tuy nhiÃªn, khÃ¡c vá»›i CMOVZ, tÃ¬m block Ä‘Ã­ch khÃ´ng cÃ²n dÃ¹ng kiá»ƒu tÃ¬m block cÃ³ Ä‘á»‹a chá»‰ gáº§n nháº¥t Ä‘Æ°á»£c ná»¯a â˜¹. MÃ  thÃ´ng qua debug, mÃ¬nh Ä‘á»ƒ Ã½ 1 imm32 thÃ¬ váº«n tuÃ¢n theo quy táº¯c Ä‘á»‹a chá»‰ gáº§n nháº¥t, nhÆ°ng imm32 cÃ²n láº¡i sáº½ match theo pair index. Kiá»ƒu nhÆ° tháº¿ nÃ y:
</p>
<img class="image-container" src="21.jpg" alt="CFF21">
<p>
    Idea khÃ¡ rÃµ rÃ ng rá»“i Ä‘Ãºng khÃ´ng, tÆ°Æ¡ng tá»± nhÆ° CMOVZ, ta sáº½ patch JB vÃ o variant CMOVB nÃ y:
</p>
<img class="image-container" src="22.jpg" alt="CFF22">
<p>
    NgoÃ i 2 variant chá»§ Ä‘áº¡o nÃ y, cÃ²n 1 variant ná»¯a, nhÆ°ng nÃ³ tÆ°Æ¡ng tá»± pattern MOV, IMM32;JMP nhÆ°ng khÃ´ng cÃ³ JMP thÃ´i, mÃ¬nh sáº½ khÃ´ng Ä‘á» cáº­p á»Ÿ Ä‘Ã¢y.
</p>
<p>
    Sau khi tá»•ng há»£p láº¡i cÃ¡c pattern, thá»±c hiá»‡n deob vÃ  Ä‘Ã¢y lÃ  káº¿t quáº£ sau khi deob cá»§a chÃºng ta:
</p>
<img class="image-container" src="23.jpg" alt="CFF23">
<p>
    Flow vá» cÆ¡ báº£n lÃ  cÅ©ng retrieve gáº§n háº¿t rá»“i. VÃ¬ bÃ i nÃ y mÃ¬nh chá»‰ Ä‘i vÃ o nghiÃªn cá»©u deob CFF thÃ´i nÃªn sáº½ bá» qua cÃ¡c string obfuscate báº±ng MBA khÃ¡c. VÃ­ dá»¥ nhÆ° trÃªn hÃ¬nh, mswpft~Q lÃ  encrypted string tá»« API sau:
</p>
<img class="image-container" src="24.jpg" alt="CFF24">
<p>
    Tuy nhiÃªn cÅ©ng bá»Ÿi obfus MBA quÃ¡ báº©n, mÃ¬nh khÃ´ng rÃµ mÃ¬nh deob 100% khÃ´ng? Váº­y nÃªn tiáº¿p theo mÃ¬nh sáº½ tá»± xiÃªn 1 máº«u cá»§a mÃ¬nh cÃ³ API rÃµ rÃ ng Ä‘á»ƒ theo dÃµi káº¿t quáº£ ok hÆ¡n :v.
</p>
<h2>Sample 2 â€” Custom MÃ¨o</h2>
<p>
    Máº«u thá»© 2 lÃ  malware ná»™i bá»™ mÃ¬nh tá»± dev. Vá»›i obfus command nhÆ° sau:
</p>
<pre><code>
clang-cl.exe /LD dllmain.cpp 
-mllvm -fla 
-mllvm -bcf 
-mllvm -bcf_prob=100 
-mllvm -bcf_loop=2 
-mllvm -sub
</code></pre>
<p>
    Äáº¿n vá»›i cÃ¡ch tiáº¿p cáº­n máº«u thá»© 2 nÃ y, váº«n bÃ¡m theo format cÅ© thÃ´i. TrÆ°á»›c tiÃªn váº«n lÃ  tÃ¬m dispatcher block báº±ng block nhiá»u pred nháº¥t:
</p>
<img class="image-container" src="25.jpg" alt="CFF25">
<img class="image-container" src="26.jpg" alt="CFF26">
<p>
    Well, nhÆ°ng ta cÃ³ thá»ƒ tháº¥y á»Ÿ Ä‘Ã¢y dispatcher khÃ´ng sá»­ dá»¥ng register ná»¯a, mÃ  dÃ¹ng memory Ä‘á»ƒ lÆ°u cÃ¡c giÃ¡ trá»‹ switch flow. 
</p>
<p>
    Tháº¿ nhÆ°ng sá»± khÃ¡c biá»‡t lÃ  khÃ´ng Ä‘Ã¡ng bao nhiÃªu cáº£, báº£n cháº¥t cá»§a block trÃªn váº«n lÃ  mov imm32 vÃ o dispatcher, sau Ä‘Ã³ dÃ¹ng zero flag Ä‘á»ƒ switch flow (sub, jz == cmp, jz). Patch tÆ°Æ¡ng tá»± nhÆ° cÅ©, chá»‰ khÃ¡c pattern Ä‘i 1 chÃºt:
</p>
<img class="image-container" src="27.jpg" alt="CFF27">
<p>
    Máº«u nÃ y tÆ°Æ¡ng tá»± sá»­ dá»¥ng cÃ¡c obfus Ä‘Æ¡n giáº£n báº±ng MOV Dispatch mem, Imm32 sau Ä‘Ã³ JMP hoáº·c khÃ´ng, mÃ¬nh sáº½ khÃ´ng Ä‘i chi tiáº¿t vÃ o ná»¯a:
</p>
<img class="image-container" src="28.jpg" alt="CFF28">
<img class="image-container" src="29.jpg" alt="CFF29">
<p>
    Máº«u cÅ©ng sá»­ dá»¥ng CMOVNZ vÃ o obfus. Tuy nhiÃªn, cÃ¡ch tiáº¿p cáº­n cá»§a nÃ³ ráº¥t khÃ¡c máº«u trÆ°á»›c, cÃ³ 2 variant CMOVNZ, mÃ¬nh sáº½ Ä‘i vÃ o tá»«ng cÃ¡i 1.
</p>
<h2>1. Variant Patterns.</h2>
<h3>1.1. CMOVNZ with Global variable.</h3>
<p>
    Pattern nÃ y gáº·p khÃ¡ nhiá»u trong xuyÃªn suá»‘t luá»“ng chÆ°Æ¡ng trÃ¬nh:
</p>
<img class="image-container" src="30.jpg" alt="CFF30">
<p>
    CÃ¡c global variable nÃ y Ä‘c init runtime:
</p>
<img class="image-container" src="31.jpg" alt="CFF31">
<p>Váº­y nÃªn lÃ m sao Ä‘á»ƒ biáº¿t dl tráº£ vá» bao nhiÃªu mÃ  make flow?</p>
<p>Táº¡i Ä‘Ã¢y, mÃ¬nh dÃ¹ng unicorn emulate láº¡i báº¯t Ä‘áº§u mov reg32, global var Ä‘áº§u tiÃªn tá»›i lá»‡nh test dl, 1:</p>
<img class="image-container" src="32.jpg" alt="CFF32">
<p>
    CÃ³ váº» chá»‰ lÃ  obfus tÃ­nh toÃ¡n linh tinh, vÃ  báº¥t ká»ƒ 2 global variable kia báº±ng bao nhiÃªu, dl luÃ´n luÃ´n tráº£ vá» <code>True</code>. Tá»« Ä‘Ã¢y, ta cÃ³ thá»ƒ xá»­ lÃ½ variant nÃ y báº±ng cÃ¡ch patch JMP tháº³ng Ä‘áº¿n IMM32 cá»§a ecx luÃ´n :D, tÆ°Æ¡ng Ä‘á»‘i dá»….
</p>
<h3>1.2. CMOVNZ with out Global variable.</h3>
<p>
    Nhá»¯ng pattern nÃ y thÃ¬ khÃ´ng cÃ³ Global variable á»Ÿ Ä‘áº§u:
</p>
<img class="image-container" src="33.jpg" alt="CFF33">
<p>
    Local var Ä‘Æ°á»£c mov vÃ o dl nÃ y láº¡i lÃ  giÃ¡ trá»‹ Ä‘Æ°á»£c xá»­ lÃ½ theo nhá»¯ng Ä‘oáº¡n code â€œcÃ³ nghÄ©aâ€:
</p>
<img class="image-container" src="34.jpg" alt="CFF34">
<p>
    ÄÃ¢m ra khÃ¡ lÃ  khÃ³ Ä‘á»ƒ emu mÃ  biáº¿t Ä‘Æ°á»£c dl lÃ  bao nhiÃªu. Khi nÃ y mÃ¬nh náº£y ra Ã½ tÆ°á»Ÿng lÃ  sao khÃ´ng ká»‡ luÃ´n nhá»‰, patch thÃ nh condition jump dá»±a theo 2 imm32 Ä‘Ã­ch lÃ  Ä‘Æ°á»£c :D.
</p>
<p>
    Well, vÃ  káº¿t quáº£ sau khi patch thÃ¬ cá»±c kÃ¬ Ä‘áº¹p. From this:
</p>
<img class="image-container" src="35.jpg" alt="CFF35">
<p>To this:</p>
<img class="image-container" src="36.jpg" alt="CFF36">

<p>Táº¥t cáº£ nhá»¯ng hÃ m bá»‹ CFF trong máº«u nÃ y, mÃ¬nh Ä‘á»u cÃ³ thá»ƒ recover gáº§n nhÆ° nguyÃªn báº£n háº¿t:</p>
<img class="image-container" src="37.jpg" alt="CFF37">
<img class="image-container" src="38.jpg" alt="CFF38">
<img class="image-container" src="39.jpg" alt="CFF39">


<h2>Summary.</h2>

<p>NhÆ° váº­y lÃ  ta vá»«a Ä‘i qua 2 máº«u CFFed vÃ  hÆ°á»›ng Ä‘á»ƒ deob. TÃ³m gá»n láº¡i, khi deob CFF, mÃ¬nh luÃ´n chÃº trá»ng Ä‘áº¿n tÃ¬m Ä‘Æ°á»£c 3 thá»© máº¥u chá»‘t nhÆ° sau:</p>

<ul>
<li>TÃ¬m CFF Dispatcher(s).</li>
<li>TÃ¬m Destination Ä‘á»‘i vá»›i tá»«ng IMM.</li>
<li>TÃ¬m vÃ  xá»­ lÃ½ cÃ¡c Variant pattern.</li>
</ul>

<p>
Tá»« nhá»¯ng dá»¯ kiá»‡n Ä‘Ã³, ta hoÃ n toÃ n cÃ³ thá»ƒ ná»‘i chÃºng vá» flow gá»‘c tÆ°Æ¡ng Ä‘á»‘i ok.
</p>

<p>
    -> ÄÃ¢y lÃ  toÃ n bá»™ chia sáº» vá» kinh nghiá»‡m trong suá»‘t quÃ¡ trÃ¬nh tÃ¬m hiá»ƒu, nghiÃªn cá»©u deob CFF cá»§a mÃ¬nh. CÃ³ thá»ƒ mÃ¬nh chÆ°a gáº·p nhiá»u cÃ¡c variant vÃ  cÃ¡c kiá»ƒu CFF khÃ³ hÆ¡n khÃ¡c, nÃªn náº¿u cÃ³ gÃ¬ thiáº¿u hoáº·c sai sÃ³t, mong Ä‘Æ°á»£c Ä‘Ã³ng gÃ³p qua tin nháº¯n :3. Cáº£m Æ¡n Ä‘Ã£ Ä‘á»c!
</p>

<h2>Script</h2>
<a href="scripts\CFF1.py" style="color:pink;">PlugX deobfuscate script</a>
<br>
<a href="scripts\CFF2.py" style="color:pink;">Custom mlaware deobfuscate script</a>

<h2>Sample</h2>
<a href="samples\plugx\password-[infected].zip" style="color:pink;">PlugX sample</a>
<br>
<a href="samples\custom\password-[infected].zip" style="color:pink;">Custom sample</a>


</main>
</body>
</html>
